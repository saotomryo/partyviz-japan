<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PartyViz Admin</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .admin-grid { display: grid; grid-template-columns: 360px 1fr; gap: 18px; padding: 22px 24px 40px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end; }
    .row > * { flex: 1; min-width: 160px; }
    input, textarea {
      background: var(--panel);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 14px;
      width: 100%;
    }
    textarea { min-height: 84px; resize: vertical; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 18px 20px; box-shadow: var(--shadow); }
    .divider { height: 1px; background: var(--border); margin: 14px 0; }
    .rubric-item { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 12px; margin-bottom: 10px; }
    .rubric-item header { display: flex; justify-content: space-between; gap: 10px; align-items: center; }
    .rubric-item header h3 { margin: 0; font-size: 14px; }
    .rubric-meta { font-size: 12px; color: var(--muted); margin: 6px 0 0; }
    .pill { padding: 4px 8px; border-radius: 999px; font-size: 12px; border: 1px solid var(--border); background: rgba(255,255,255,0.06); }
    .pill.active { border-color: rgba(87,209,163,0.5); color: var(--accent); }
    .pill.draft { border-color: rgba(122,213,255,0.5); color: var(--accent-2); }
    .pill.archived { border-color: rgba(255,127,107,0.5); color: var(--danger); }
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid var(--border); padding: 8px; vertical-align: top; }
    th { text-align: left; color: var(--muted); font-weight: 700; font-size: 12px; }
    .small { font-size: 12px; color: var(--muted); }
    .link { color: var(--accent-2); text-decoration: none; }
  </style>
</head>
<body>
  <header class="hero">
    <div class="hero__content">
      <p class="eyebrow">PartyViz Admin</p>
      <h1>管理（トピック / ルーブリック）</h1>
      <p class="lede">トピック登録、ルーブリック生成（AI）、編集、アクティブ化を操作します。</p>
      <div class="controls">
        <label>
          API Base
          <input id="apiBase" placeholder="http://localhost:8000" />
        </label>
        <label>
          X-API-Key（任意）
          <input id="apiKey" placeholder="admin-key（未設定なら空でOK）" />
        </label>
        <label>
          検索プロバイダ
          <select id="searchProvider">
            <option value="auto">auto</option>
            <option value="gemini">gemini</option>
            <option value="openai">openai</option>
          </select>
        </label>
        <label>
          ルーブリック生成プロバイダ
          <select id="rubricProvider">
            <option value="auto">auto</option>
            <option value="gemini">gemini</option>
            <option value="openai">openai</option>
          </select>
        </label>
        <div style="align-self:flex-end;">
          <button class="button-link" id="saveConfig">API設定を保存</button>
          <a class="button-link link" href="index.html" style="margin-left:8px; display:inline-block;">公開UIへ</a>
        </div>
      </div>
    </div>
  </header>

  <main class="admin-grid">
    <aside class="panel">
      <div class="panel__header">
        <h2>トピック</h2>
      </div>
      <div style="padding: 12px;">
        <div class="row">
        <label>topic_id（任意）<input id="topicId" placeholder="（空なら自動生成）" /></label>
        <label>name<input id="topicName" placeholder="財政規律" /></label>
        <label style="min-width: 140px;">active
          <select id="topicActive">
            <option value="true">true</option>
            <option value="false">false</option>
          </select>
        </label>
      </div>
      <label style="margin-top:10px;">description<textarea id="topicDesc" placeholder="積極財政か規律重視か"></textarea></label>
      <label style="margin-top:10px;">search_subkeywords（自動生成・確認用）<textarea id="topicSubkeywords" readonly placeholder="（追加/更新時に生成されます）"></textarea></label>
      <div class="row" style="margin-top:10px;">
        <button class="button-link" id="upsertTopic">追加/更新</button>
        <button class="button-link" id="refreshTopics">一覧更新</button>
      </div>
      </div>
      <div class="divider"></div>
      <ul id="topicList" class="topic-list"></ul>
    </aside>

    <section class="card">
      <div class="content__header">
        <div>
          <p class="eyebrow" id="selTopicId">topic</p>
          <h2 id="selTopicTitle">トピックを選択してください</h2>
          <p class="muted" id="selTopicDesc"></p>
        </div>
      </div>

      <div class="divider"></div>

      <h3 style="margin:0 0 8px;">LLMモデル設定</h3>
      <p class="small">モデル名は編集可能です（候補から選ぶ/直接入力）。保存はこの欄の「LLM設定を保存」です。</p>
      <div class="row">
        <label>OpenAI（検索）model<input id="openaiSearchModel" list="openaiSearchModelList" placeholder="gpt-4o-mini-search-preview" /></label>
        <label>Gemini（検索）model<input id="geminiSearchModel" list="geminiSearchModelList" placeholder="models/gemini-2.5-flash" /></label>
      </div>
      <div class="row" style="margin-top:10px;">
        <label>OpenAI（生成）model<input id="openaiRubricModel" list="openaiRubricModelList" placeholder="gpt-5-mini" /></label>
        <label>Gemini（生成）model<input id="geminiRubricModel" list="geminiRubricModelList" placeholder="models/gemini-2.5-flash" /></label>
      </div>
      <div class="row" style="margin-top:10px;">
        <button class="button-link" id="saveLLMConfig">LLM設定を保存</button>
      </div>

      <datalist id="openaiSearchModelList">
        <option value="gpt-4o-mini-search-preview"></option>
      </datalist>
      <datalist id="openaiRubricModelList">
        <option value="gpt-5-mini"></option>
        <option value="gpt-4o-mini"></option>
      </datalist>
      <datalist id="geminiSearchModelList">
        <option value="models/gemini-2.5-flash"></option>
        <option value="models/gemini-2.5-pro"></option>
        <option value="models/gemini-1.5-flash"></option>
      </datalist>
      <datalist id="geminiRubricModelList">
        <option value="models/gemini-2.5-flash"></option>
        <option value="models/gemini-2.5-pro"></option>
        <option value="models/gemini-1.5-flash"></option>
      </datalist>

      <div class="divider"></div>

      <h3 style="margin:0 0 8px;">ルーブリック生成（ドラフト）</h3>
      <div class="row">
        <label>topic_name<input id="genTopicName" placeholder="財政規律" /></label>
        <label>steps_count<input id="genStepsCount" type="number" min="3" max="9" value="5" /></label>
      </div>
      <div class="row" style="margin-top:10px;">
        <label>axis_a_hint<input id="axisAHint" placeholder="積極財政（財政出動）" /></label>
        <label>axis_b_hint<input id="axisBHint" placeholder="規律重視（PB/債務抑制）" /></label>
      </div>
      <label style="margin-top:10px;">description<textarea id="genDesc" placeholder="説明（任意）"></textarea></label>
      <div class="row" style="margin-top:10px;">
        <button class="button-link" id="generateRubric">生成して保存（POST）</button>
        <button class="button-link" id="refreshRubrics">ルーブリック一覧更新</button>
      </div>

      <div class="divider"></div>

      <h3 style="margin:0 0 8px;">ルーブリック一覧</h3>
      <div id="rubricList" class="positions"></div>
      <p class="small">編集後は「保存（PATCH）」、有効化は「Activate（POST）」です。</p>

      <div class="divider"></div>

      <h3 style="margin:0 0 8px;">スコアリング（実行 & 保存）</h3>
      <p class="small">選択中のトピックに対して、公式のみを実行しDBに保存します（外部ページは任意）。</p>
      <p class="small">対象政党数（自動・rejected除外）: <span id="scorePartyCount">-</span></p>
      <div class="row">
        <label>max_evidence_per_party<input id="scoreMaxEvidence" type="number" min="1" max="5" value="2" /></label>
        <label style="min-width: 220px;">
          <span class="small">外部ページも含める（mixed）</span>
          <input id="scoreIncludeExternal" type="checkbox" />
        </label>
        <label style="min-width: 220px;">
          <span class="small">policy index only</span>
          <input id="scoreIndexOnly" type="checkbox" />
        </label>
      </div>
      <div class="row" style="margin-top:10px;">
        <button class="button-link" id="runScoring">スコアリング実行</button>
        <button class="button-link" id="loadLatestScores">最新スコア表示</button>
      </div>
      <div id="scoreResult" style="margin-top:10px;"></div>

      <div class="divider"></div>

      <h3 style="margin:0 0 8px;">政党要旨（相対評価）</h3>
      <p class="small">最新スコアから政党要旨を再生成します（公開UIの要旨表示に反映）。</p>
      <div class="row">
        <label>scope
          <select id="summaryScope">
            <option value="official">official</option>
            <option value="mixed">mixed</option>
          </select>
        </label>
      </div>
      <div class="row" style="margin-top:10px;">
        <button class="button-link" id="runSummary">要旨を再生成</button>
      </div>
      <div id="summaryResult" style="margin-top:10px;"></div>

      <div class="divider"></div>

      <h3 style="margin:0 0 8px;">公開用スナップショット（静的ホスティング）</h3>
      <p class="small">バックエンドを公開せず、公開UIが参照する <code>snapshot.json</code> をダウンロードします。</p>
      <div class="row" style="margin-top:10px;">
        <button class="button-link" id="downloadSnapshot">スナップショットをダウンロード</button>
      </div>
      <p class="small">ダウンロードしたファイルを <code>frontend/data/snapshot.json</code> として配置して公開UIを配信してください。</p>

      <div class="divider"></div>

      <h3 style="margin:0 0 8px;">政党レジストリ</h3>
      <div class="row">
        <label>自動取得クエリ<input id="partyDiscoverQuery" placeholder="日本の国政政党（国会に議席のある政党）と主要な新党・政治団体の公式サイト一覧 チームみらい" /></label>
        <label>limit<input id="partyDiscoverLimit" type="number" min="1" max="200" value="50" /></label>
      </div>
      <div class="row" style="margin-top:10px;">
        <button class="button-link" id="discoverParties">自動取得して反映</button>
      </div>
      <div class="divider"></div>
      <p class="small">下の一覧から政党をクリックすると編集できます。</p>
      <div class="rubric-meta">選択中: <span id="selectedPartyId">(none)</span></div>
      <div class="row">
        <label>name_ja<input id="partyNameJa" placeholder="自由民主党" /></label>
        <label>official_home_url<input id="partyHomeUrl" placeholder="https://www.jimin.jp/" /></label>
      </div>
      <div class="row" style="margin-top:10px;">
        <label>allowed_domains（カンマ区切り）<input id="partyDomains" placeholder="www.jimin.jp,jimin.jp" /></label>
        <label>confidence<input id="partyConfidence" type="number" min="0" max="1" step="0.01" value="0.5" /></label>
        <label>status
          <select id="partyStatus">
            <option value="candidate">candidate</option>
            <option value="verified">verified</option>
            <option value="needs_review">needs_review</option>
            <option value="rejected">rejected</option>
          </select>
        </label>
      </div>
      <label style="margin-top:10px;">policy_base_urls（改行区切り）<textarea id="partyPolicyUrls" placeholder="https://o-ishin.jp/policy/"></textarea></label>
      <label style="margin-top:10px;">evidence（JSON）<textarea id="partyEvidence" placeholder='{"note":"seed"}'></textarea></label>
      <div class="row" style="margin-top:10px;">
        <button class="button-link" id="createParty">登録（POST）</button>
        <button class="button-link" id="updateParty">更新（PATCH）</button>
        <button class="button-link" id="clearPartyForm">フォームクリア</button>
        <button class="button-link" id="refreshParties">一覧更新</button>
        <button class="button-link" id="crawlPolicySources">政策URLをクロール</button>
      </div>
      <div id="partyList" style="margin-top:10px;"></div>

      <div class="divider"></div>
      <h3 style="margin:0 0 8px;">メンテナンス（開発用）</h3>
      <p class="small">危険: DBのデータを削除します。実行時に「DELETE」と入力が必要です。</p>
      <div class="row" style="margin-top:10px;">
        <button class="button-link" id="purgeParties">政党（+イベント）を全削除</button>
        <button class="button-link" id="purgeTopics">トピック/ルーブリックを全削除</button>
        <button class="button-link" id="purgeAll">すべて全削除</button>
      </div>
    </section>
  </main>

  <script src="admin.js"></script>
</body>
</html>
